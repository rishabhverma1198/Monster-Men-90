/**
 * Core Philosophy: This ruleset governs an e-commerce application backend. The security model is
 * admin-centric, where a specific admin user has full write access to all data, while the general
 * public (including unauthenticated users) has read-only access to the product catalog.
 *
 * Data Structure:
 * - /products/{productId}: A public collection of all products.
 * - /products/{productId}/variants/{variantId}: A public subcollection for product sizes and stock.
 * - /orders_leads/{orderId}: A private collection for customer orders.
 *
 * Key Security Decisions:
 * - Admin-Only Writes: All write operations (create, update, delete) across the entire database
 *   are restricted to a single, hardcoded admin user UID. This ensures data integrity.
 * - Public Product Catalog: The `/products` collection and its `variants` subcollections are
 *   publicly readable and listable to allow any user or guest to browse the store.
 * - Private Orders: The `/orders_leads` collection is write-only for the public (to place orders)
 *   and completely restricted from being read or listed by anyone except the admin. This protects
 *   sensitive customer information like names and phone numbers.
 * - Guest Checkouts: Order creation is permitted for any user, including anonymous ones, to
 *   facilitate a simple guest checkout process without requiring user accounts.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable and reusable logic.

    /**
     * Checks if the request is from the designated admin user.
     * IMPORTANT: Replace 'YOUR_ADMIN_UID_HERE' with the actual Firebase Auth UID of the admin.
     */
    function isAdmin() {
      // TODO: Replace with the actual Firebase Auth UID for the admin account.
      return request.auth != null && request.auth.uid == 'YOUR_ADMIN_UID_HERE';
    }

    /**
     * @description Publicly readable product catalog, manageable only by an admin.
     * @path /products/{productId}
     * @allow (get) Any user, authenticated or not, can read a specific product's details.
     * @deny (create) A non-admin user attempts to create a new product.
     * @principle Public read access for catalog items with admin-only write control to protect data integrity.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Publicly readable product variants (e.g., sizes, stock), manageable only by an admin.
     * @path /products/{productId}/variants/{variantId}
     * @allow (get) Any user can view the stock or price for a specific product size.
     * @deny (update) A non-admin user attempts to change the stock level of a variant.
     * @principle Enforces relational integrity by ensuring a variant is always linked to its parent product.
     */
    match /products/{productId}/variants/{variantId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && request.resource.data.productId == productId;
      allow update: if isAdmin() && resource != null && request.resource.data.productId == resource.data.productId;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores customer orders. Anyone can create an order (guest checkout),
     * but only the admin can view or manage them to protect customer privacy.
     * @path /orders_leads/{orderId}
     * @allow (create) An unauthenticated guest user successfully places a new order.
     * @deny (list) An authenticated user attempts to list all orders in the system.
     * @principle Protects sensitive user data (PII) by making orders write-only for the public and read-only for the admin.
     */
    match /orders_leads/{orderId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}