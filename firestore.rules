/**
 * This ruleset provides security for the MonserMens90 e-commerce application.
 *
 * Core Philosophy:
 * The security model is designed for a public-facing product catalog with a secure, admin-only management backend.
 * It uses a Role-Based Access Control (RBAC) system where admin privileges are granted by the existence of a document
 * in the `/roles_admin` collection. This allows for secure management of products and orders.
 *
 * Data Structure:
 * - /products/{productId}: Publicly readable product data.
 *   - /variants/{variantId}: Publicly readable product variants (e.g., sizes).
 * - /orders_leads/{orderId}: Private order data, created by any user (including guests).
 * - /roles_admin/{uid}: A list of admin users, where the document ID is the user's Auth UID.
 *
 * Key Security Decisions:
 * - Product Catalog: The entire `/products` collection and its subcollections are publicly readable to allow any visitor
 *   to browse the store. However, all write operations (create, update, delete) are restricted to authenticated admins.
 * - Guest Checkouts: To support users placing orders without creating an account, the `create` operation on `/orders_leads`
 *   is open to everyone.
 * - Order Privacy: Once an order is created, it becomes private. All read and write access (get, list, update, delete)
 *   to the `/orders_leads` collection is strictly limited to admins to protect customer PII.
 * - Admin Management: The ability to grant or revoke admin privileges is restricted to users who are already admins.
 *
 * Denormalization for Authorization:
 * Instead of embedding an `isAdmin` flag in a user profile document (which would require a costly `get()` call in rules),
 * this ruleset uses a dedicated `/roles_admin/{uid}` collection. This allows for a highly performant authorization check
 * using `exists()`, which does not incur a read charge and is optimized for this exact use case.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user has admin privileges.
     * Admin status is granted by the existence of a document for the user's UID
     * in the /roles_admin collection. This is a fast and non-billable check.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * @description Manages the product catalog. Products are public for all to see, but only admins can create, modify, or delete them.
     * @path /products/{productId}
     * @allow (get) Any user, signed in or not, can view a product.
     * @deny (create) A non-admin user cannot add a new product.
     * @principle Public Read with Admin-Only Writes. This protects the integrity of the store's catalog while allowing public browsing.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

      /**
       * @description Manages product variants (e.g., sizes). Follows the same security model as the parent product.
       * @path /products/{productId}/variants/{variantId}
       * @allow (get) Any user can view the available sizes and stock for a product.
       * @deny (update) A regular signed-in user cannot change the stock level of a variant.
       * @principle Enforces relational integrity by ensuring a variant's `productId` field matches its parent document path.
       */
      match /variants/{variantId} {
        allow get: if true;
        allow list: if true;
        allow create: if isAdmin() && request.resource.data.productId == productId;
        allow update: if isAdmin() && resource != null && request.resource.data.productId == resource.data.productId;
        allow delete: if isAdmin() && resource != null;
      }
    }

    /**
     * @description Stores order leads from customers. Allows anyone to create an order (guest checkout) but locks down all other access to admins.
     * @path /orders_leads/{orderId}
     * @allow (create) An anonymous guest user can successfully place an order.
     * @deny (get) A signed-in, non-admin user cannot read another user's order details.
     * @principle Public Create, Private Read/Manage. This supports guest checkouts while protecting sensitive customer order information (PII).
     */
    match /orders_leads/{orderId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Defines which users are administrators. The existence of a document grants the role.
     * @path /roles_admin/{uid}
     * @allow (create) An existing admin can add a new document to make another user an admin.
     * @deny (create) A non-admin user cannot create a document here to grant themselves admin privileges.
     * @principle Admin-Managed Roles. Ensures that only existing administrators can manage the list of who has administrative access.
     */
    match /roles_admin/{uid} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}